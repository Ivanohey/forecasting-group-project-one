# 4. Model Selection

## Methodology
To evaluate the forecast accuracy, we will test how a model performs on new data not used during the fitting phase.
We split our data into training and test set. The first one we will use to estimate any parameters of the forecasting method, and the second - is to define the model's accuracy. 
We fit the training data to models selected (ARIMA, ETS, SNAIVE) to forecast 60 following periods (in our case, months). 
We refit our models with test data and calculate the accuracy of the forecast. 
We select the model with the lowest accuracy metrics for further forecast. Low metric values indicate the better predictive performance of the model, with a value of 0 indicating a perfect fit between the predicted and actual values. 
Residuals analysis is also going to be plotted to see how well the model captures the dynamics of the data. Good models' residuals should be stationary (white noise) and have no patterns. 

We can see strong seasonality and trend in data from our decomposition analysis, so we tested ARIMA, ETS, and Seasonal NAIVE models as we assume these models can handle these types of data the best. 

As the most accurate forecast is of interest, we will give more weight to the model with low values of RMSE and MAE, even though another model has a higher AIC (see Appendix 2.).

## 4.1 Germany{.tabset}

```{r}

Germany_since_2015 <- data_elec %>% 
  select(Date,Germany) %>% 
  suppressWarnings(filter(Date >= as.Date("2015-01-01")))
```

### **Testing Models**
Below is the plot of how well each model fits the data based on a 60-period prediction starting from 2016. 
```{r, warning=FALSE}

#Split the data
training_ge <- data_elec %>% select(Date,Germany) %>% filter(Date < as.Date("2016-01-01"))
test_ge <- data_elec %>% select(Date,Germany) %>% filter(Date >= as.Date("2016-01-01"))
```

```{r}
# Fit ARIMA model and generate forecasts
data_fit_ge_a <- training_ge %>%
  model(ARIMA(Germany))
forecasts_ge_a <- data_fit_ge_a %>%
  forecast(h = 60)

# Fit ETS model and generate forecasts
data_fit_ge_e <- training_ge %>%
  model(ETS(Germany))
forecasts_ge_e <- data_fit_ge_e %>%
  forecast(h = 60)

# Fit seasonal naive model and generate forecasts
data_fit_ge_n <- training_ge %>%
  model(SNAIVE(Germany))
forecasts_ge_n <- data_fit_ge_n %>%
  forecast(h = 60)

# Combine forecasts into a single data frame
all_forecasts_ge <- bind_rows(
  data.frame(Date = forecasts_ge_a$Date, Method = "ARIMA", Forecast = forecasts_ge_a$.mean),
  data.frame(Date = forecasts_ge_e$Date, Method = "ETS", Forecast = forecasts_ge_e$.mean),
  data.frame(Date = forecasts_ge_n$Date, Method = "SNAIVE", Forecast = forecasts_ge_n$.mean))


# Plot all three sets of forecasts together
data_elec %>% autoplot(Germany)  +
  geom_line(data = all_forecasts_ge, aes(x = Date, y = Forecast, color = Method)) +
  labs(title = "Electricity Consumption in Germany")

```


### **Measuring Model Accuracy**
According to the accuracy table RMSE, MAE and other indicators, ETS has the lowest values on the test data. 
The ARIMA model has an AIC of AIC=2260.11, AICc of AICc=2260.6, and BIC of 2279.27. On the other hand, the ETS model has an AIC of 2797.057, AICc of 2799.784, and BIC of 2845.919. Therefore, based on these criteria, we can conclude that the ARIMA model fits the data better than the ETS model.

```{r}
#Accuracy
germany_accuracy_a <- accuracy(forecasts_ge_a, test_ge)

germany_accuracy_e <- accuracy(forecasts_ge_e, test_ge)

germany_accuracy_n <- accuracy(forecasts_ge_n, test_ge)

germany_accuracy_table <- rbind(
  data.frame(germany_accuracy_a),
  data.frame(germany_accuracy_e),
  data.frame(germany_accuracy_n))



#AIC
germany_accuracy_table
report(data_fit_ge_a)
report(data_fit_ge_e)



```

### **Residuals**
The output below also suggests that the ARIMA model did well in capturing all the dynamics in data, as the residuals seem to be white noise.
```{r}
gg_tsresiduals(data_fit_ge_a) + labs(title = "ARIMA Germany residuals analysis")

gg_tsresiduals(data_fit_ge_e) + labs(title = "ETS Germany residuals analysis")

gg_tsresiduals(data_fit_ge_n) + labs(title = "SNAIVE Germany residuals analysis")
```




















